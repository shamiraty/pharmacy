'use client';

import { useState, useEffect, useRef } from 'react';
import {
  Plus,
  Search,
  Edit2,
  Trash2,
  Eye,
  Filter,
  Download,
  Upload,
  AlertCircle,
  FileSpreadsheet,
  FileText,
  ChevronRight,
  ChevronLeft,
  Check,
} from 'lucide-react';
import Swal from 'sweetalert2';
import { isAdmin } from '@/lib/auth';
import { logActivity } from '@/lib/activity';
import Pagination from '@/components/Pagination';
import LoadingSpinner from '@/components/LoadingSpinner';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

interface Medicine {
  id: number;
  name: string;
  generic_name: string;
  category_name: string;
  manufacturer: string;
  selling_price_full: number;
  quantity_in_stock: number;
  expiry_date: string;
  stock_status: string;
}

export default function MedicinesPage() {
  const [medicines, setMedicines] = useState<Medicine[]>([]);
  const [categories, setCategories] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showViewModal, setShowViewModal] = useState(false);
  const [showImportModal, setShowImportModal] = useState(false);
  const [showExportModal, setShowExportModal] = useState(false);
  const [selectedMedicine, setSelectedMedicine] = useState<any>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterCategory, setFilterCategory] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 15;
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [currentStep, setCurrentStep] = useState(1);
  const totalSteps = 4;

  const [formData, setFormData] = useState({
    name: '',
    generic_name: '',
    category_id: '',
    manufacturer: '',
    purchase_price_per_carton: '',
    units_per_carton: '',
    selling_price_full: '',
    selling_price_half: '',
    selling_price_single: '',
    quantity_in_stock: '',
    reorder_level: '10',
    diseases_treated: '',
    dosage_form: '',
    strength: '',
    usage_instructions: '',
    side_effects: '',
    manufacture_date: '',
    expiry_date: '',
    barcode: '',
    shelf_location: '',
  });

  useEffect(() => {
    fetchMedicines();
    fetchCategories();
  }, [searchTerm, filterCategory]);

  const fetchMedicines = async () => {
    try {
      setLoading(true);
      const params = new URLSearchParams();
      if (searchTerm) params.append('search', searchTerm);
      if (filterCategory) params.append('category', filterCategory);

      const response = await fetch(`/api/medicines?${params}`);
      const data = await response.json();

      if (data.success) {
        setMedicines(data.data);
      }
    } catch (error) {
      console.error('Error fetching medicines:', error);
      Swal.fire('Error', 'Failed to fetch medicines', 'error');
    } finally {
      setLoading(false);
    }
  };

  const fetchCategories = async () => {
    try {
      const response = await fetch('/api/categories');
      const data = await response.json();

      if (data.success) {
        setCategories(data.data);
      }
    } catch (error) {
      console.error('Error fetching categories:', error);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSubmitting(true);

    try {
      const response = await fetch('/api/medicines', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      const data = await response.json();

      if (data.success) {
        await logActivity('medicine_added', `Added ${formData.name}`);
        Swal.fire({
          title: 'Success!',
          text: 'Medicine added successfully',
          icon: 'success',
          confirmButtonColor: '#0ea5e9',
        });
        setShowAddModal(false);
        resetForm();
        fetchMedicines();
      } else {
        Swal.fire('Error', data.error, 'error');
      }
    } catch (error) {
      Swal.fire('Error', 'Failed to add medicine', 'error');
    } finally {
      setSubmitting(false);
    }
  };

  const handleView = (medicine: any) => {
    setSelectedMedicine(medicine);
    setShowViewModal(true);
  };

  const handleEdit = (medicine: any) => {
    setSelectedMedicine(medicine);
    setFormData({
      name: medicine.name || '',
      generic_name: medicine.generic_name || '',
      category_id: medicine.category_id?.toString() || '',
      manufacturer: medicine.manufacturer || '',
      purchase_price_per_carton: medicine.purchase_price_per_carton?.toString() || '',
      units_per_carton: medicine.units_per_carton?.toString() || '',
      selling_price_full: medicine.selling_price_full?.toString() || '',
      selling_price_half: medicine.selling_price_half?.toString() || '',
      selling_price_single: medicine.selling_price_single?.toString() || '',
      quantity_in_stock: medicine.quantity_in_stock?.toString() || '',
      reorder_level: medicine.reorder_level?.toString() || '10',
      diseases_treated: medicine.diseases_treated || '',
      dosage_form: medicine.dosage_form || '',
      strength: medicine.strength || '',
      usage_instructions: medicine.usage_instructions || '',
      side_effects: medicine.side_effects || '',
      manufacture_date: medicine.manufacture_date?.split('T')[0] || '',
      expiry_date: medicine.expiry_date?.split('T')[0] || '',
      barcode: medicine.barcode || '',
      shelf_location: medicine.shelf_location || '',
    });
    setShowEditModal(true);
  };

  const handleUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    setSubmitting(true);

    try {
      const response = await fetch('/api/medicines', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: selectedMedicine.id, ...formData }),
      });

      const data = await response.json();

      if (data.success) {
        await logActivity('medicine_updated', `Updated ${formData.name}`);
        Swal.fire({
          title: 'Success!',
          text: 'Medicine updated successfully',
          icon: 'success',
          confirmButtonColor: '#0ea5e9',
        });
        setShowEditModal(false);
        setSelectedMedicine(null);
        resetForm();
        fetchMedicines();
      } else {
        Swal.fire('Error', data.error, 'error');
      }
    } catch (error) {
      Swal.fire('Error', 'Failed to update medicine', 'error');
    } finally {
      setSubmitting(false);
    }
  };

  const handleDelete = async (id: number) => {
    const result = await Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#6b7280',
      confirmButtonText: 'Yes, delete it!',
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch(`/api/medicines?id=${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();

        if (data.success) {
          await logActivity('medicine_deleted', `Deleted medicine ID ${id}`);
          Swal.fire('Deleted!', 'Medicine has been deleted.', 'success');
          fetchMedicines();
        } else {
          Swal.fire('Error', data.error || 'Failed to delete medicine', 'error');
        }
      } catch (error) {
        Swal.fire('Error', 'Failed to delete medicine', 'error');
      }
    }
  };

  const resetForm = () => {
    setFormData({
      name: '',
      generic_name: '',
      category_id: '',
      manufacturer: '',
      purchase_price_per_carton: '',
      units_per_carton: '',
      selling_price_full: '',
      selling_price_half: '',
      selling_price_single: '',
      quantity_in_stock: '',
      reorder_level: '10',
      diseases_treated: '',
      dosage_form: '',
      strength: '',
      usage_instructions: '',
      side_effects: '',
      manufacture_date: '',
      expiry_date: '',
      barcode: '',
      shelf_location: '',
    });
  };

  const getStatusBadge = (status: string) => {
    const styles = {
      expired: 'bg-red-100 text-red-800',
      expiring_soon: 'bg-yellow-100 text-yellow-800',
      low_stock: 'bg-orange-100 text-orange-800',
      active: 'bg-green-100 text-green-800',
    };

    const labels = {
      expired: 'Expired',
      expiring_soon: 'Expiring Soon',
      low_stock: 'Low Stock',
      active: 'Active',
    };

    return (
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${styles[status as keyof typeof styles]}`}>
        {labels[status as keyof typeof labels]}
      </span>
    );
  };

  const exportToExcel = () => {
    const headers = ['Name', 'Generic Name', 'Category', 'Manufacturer', 'Stock', 'Price (Full)', 'Expiry Date', 'Status'];
    const csvData = medicines.map(m => [
      m.name,
      m.generic_name || '',
      m.category_name || '',
      m.manufacturer || '',
      m.quantity_in_stock,
      m.selling_price_full,
      new Date(m.expiry_date).toLocaleDateString(),
      m.stock_status
    ]);

    let csvContent = headers.join(',') + '\n';
    csvData.forEach(row => {
      csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `medicines_export_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();

    Swal.fire({
      icon: 'success',
      title: 'Exported!',
      text: 'Medicines list exported to CSV successfully',
      timer: 2000,
    });
  };

  const exportToPDF = () => {
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text('Medicines Inventory Report', 105, 15, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });

    const tableData = medicines.map(m => [
      m.name,
      m.category_name || '',
      m.quantity_in_stock,
      `TZS ${m.selling_price_full.toLocaleString()}`,
      new Date(m.expiry_date).toLocaleDateString(),
      m.stock_status
    ]);

    autoTable(doc, {
      startY: 30,
      head: [['Medicine', 'Category', 'Stock', 'Price', 'Expiry', 'Status']],
      body: tableData,
      theme: 'striped',
      headStyles: {
        fillColor: [14, 165, 233],
        textColor: [255, 255, 255],
        fontStyle: 'bold',
      },
      alternateRowStyles: {
        fillColor: [249, 250, 251],
      },
      styles: {
        fontSize: 8,
        lineColor: [229, 231, 235],
        lineWidth: 0.5,
      },
    });

    doc.save(`medicines_report_${new Date().toISOString().split('T')[0]}.pdf`);

    Swal.fire({
      icon: 'success',
      title: 'Exported!',
      text: 'Medicines report exported to PDF successfully',
      timer: 2000,
    });
  };

  const handleFileImport = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.name.endsWith('.csv')) {
      Swal.fire('Error', 'Please upload a CSV file', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = async (event) => {
      try {
        const text = event.target?.result as string;
        const lines = text.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

        const importedData = [];
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;

          const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
          const medicine: any = {};

          headers.forEach((header, index) => {
            medicine[header.toLowerCase().replace(/ /g, '_')] = values[index];
          });

          importedData.push(medicine);
        }

        if (importedData.length === 0) {
          Swal.fire('Error', 'No valid data found in CSV', 'error');
          return;
        }

        const result = await Swal.fire({
          title: 'Import Medicines',
          text: `Found ${importedData.length} medicines. Continue import?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Import',
          cancelButtonText: 'Cancel',
        });

        if (result.isConfirmed) {
          let successCount = 0;
          let errorCount = 0;

          for (const med of importedData) {
            try {
              const response = await fetch('/api/medicines', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: med.name || med.medicine_name,
                  generic_name: med.generic_name,
                  category_id: categories.find(c => c.name === med.category)?.id || '',
                  manufacturer: med.manufacturer,
                  selling_price_full: parseFloat(med.price_full || med.price || '0'),
                  quantity_in_stock: parseInt(med.stock || med.quantity_in_stock || '0'),
                  expiry_date: med.expiry_date,
                  units_per_carton: 1,
                }),
              });

              if (response.ok) successCount++;
              else errorCount++;
            } catch (error) {
              errorCount++;
            }
          }

          await logActivity('medicines_imported', `Imported ${successCount} medicines`);

          Swal.fire({
            icon: successCount > 0 ? 'success' : 'error',
            title: 'Import Complete',
            html: `
              <p>Success: ${successCount}</p>
              <p>Failed: ${errorCount}</p>
            `,
          });

          fetchMedicines();
          setShowImportModal(false);
        }
      } catch (error) {
        Swal.fire('Error', 'Failed to parse CSV file', 'error');
      }
    };

    reader.readAsText(file);
    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Medicines</h1>
          <p className="text-gray-600 mt-1">Manage your medicine inventory</p>
        </div>
        {isAdmin() && (
          <button
            onClick={() => setShowAddModal(true)}
            className="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center space-x-2"
          >
            <Plus className="w-5 h-5" />
            <span>Add Medicine</span>
          </button>
        )}
      </div>

      {/* Filters */}
      <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
            <input
              type="text"
              placeholder="Search medicines..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
            />
          </div>

          <select
            value={filterCategory}
            onChange={(e) => setFilterCategory(e.target.value)}
            className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
          >
            <option value="">All Categories</option>
            {categories.map((cat) => (
              <option key={cat.id} value={cat.id}>
                {cat.name}
              </option>
            ))}
          </select>

          <div className="flex space-x-2">
            <button
              onClick={() => setShowExportModal(true)}
              className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center space-x-2"
            >
              <Download className="w-4 h-4" />
              <span>Export</span>
            </button>
            <button
              onClick={() => setShowImportModal(true)}
              className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center space-x-2"
            >
              <Upload className="w-4 h-4" />
              <span>Import</span>
            </button>
          </div>
        </div>
      </div>

      {/* Medicines Table */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        {loading ? (
          <LoadingSpinner message="Loading medicines..." />
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th className="text-left py-4 px-6 text-sm font-semibold text-gray-700">
                    Medicine Name
                  </th>
                  <th className="text-left py-4 px-6 text-sm font-semibold text-gray-700">
                    Category
                  </th>
                  <th className="text-left py-4 px-6 text-sm font-semibold text-gray-700">
                    Stock
                  </th>
                  <th className="text-left py-4 px-6 text-sm font-semibold text-gray-700">
                    Price
                  </th>
                  <th className="text-left py-4 px-6 text-sm font-semibold text-gray-700">
                    Expiry Date
                  </th>
                  <th className="text-left py-4 px-6 text-sm font-semibold text-gray-700">
                    Status
                  </th>
                  <th className="text-left py-4 px-6 text-sm font-semibold text-gray-700">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                {medicines.length === 0 ? (
                  <tr>
                    <td colSpan={7} className="text-center py-12 text-gray-500">
                      <AlertCircle className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                      <p>No medicines found</p>
                    </td>
                  </tr>
                ) : (
                  (() => {
                    const totalPages = Math.ceil(medicines.length / itemsPerPage);
                    const paginatedMedicines = medicines.slice(
                      (currentPage - 1) * itemsPerPage,
                      currentPage * itemsPerPage
                    );
                    return paginatedMedicines.map((medicine) => (
                      <tr
                        key={medicine.id}
                        className="border-b border-gray-100 hover:bg-gray-50 transition-colors"
                      >
                        <td className="py-4 px-6">
                          <div>
                            <div className="font-medium text-gray-900">
                              {medicine.name}
                            </div>
                            <div className="text-sm text-gray-500">
                              {medicine.generic_name}
                            </div>
                          </div>
                        </td>
                        <td className="py-4 px-6 text-gray-700">
                          {medicine.category_name}
                        </td>
                        <td className="py-4 px-6">
                          <span className="font-medium text-gray-900">
                            {medicine.quantity_in_stock}
                          </span>
                        </td>
                        <td className="py-4 px-6 text-gray-700">
                          TZS {medicine.selling_price_full?.toLocaleString()}
                        </td>
                        <td className="py-4 px-6 text-gray-700">
                          {new Date(medicine.expiry_date).toLocaleDateString()}
                        </td>
                        <td className="py-4 px-6">
                          {getStatusBadge(medicine.stock_status)}
                        </td>
                        <td className="py-4 px-6">
                          <div className="flex items-center space-x-2">
                            <button
                              onClick={() => handleView(medicine)}
                              className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                              title="View Details"
                            >
                              <Eye className="w-4 h-4" />
                            </button>
                            {isAdmin() ? (
                              <>
                                <button
                                  onClick={() => handleEdit(medicine)}
                                  className="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                  title="Edit Medicine"
                                >
                                  <Edit2 className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => handleDelete(medicine.id)}
                                  className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                  title="Delete Medicine"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </>
                            ) : (
                              <span className="text-xs text-gray-500 italic px-2">Admin only</span>
                            )}
                          </div>
                        </td>
                      </tr>
                    ));
                  })()
                )}
              </tbody>
            </table>
          </div>
        )}

        {!loading && medicines.length > 0 && (
          <Pagination
            currentPage={currentPage}
            totalPages={Math.ceil(medicines.length / itemsPerPage)}
            onPageChange={setCurrentPage}
            itemsPerPage={itemsPerPage}
            totalItems={medicines.length}
          />
        )}
      </div>

      {/* Add Medicine Modal - Multistep */}
      {showAddModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            {/* Header with Steps */}
            <div className="sticky top-0 bg-gradient-to-r from-primary-600 to-primary-700 text-white px-6 py-4 rounded-t-xl">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold">Add New Medicine</h2>
                <button
                  onClick={() => {
                    setShowAddModal(false);
                    setCurrentStep(1);
                  }}
                  className="text-white hover:bg-white/20 rounded-lg p-1 transition-colors"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>

              {/* Step Indicator */}
              <div className="flex items-center justify-between">
                {[1, 2, 3, 4].map((step) => (
                  <div key={step} className="flex items-center flex-1">
                    <div className="flex flex-col items-center flex-1">
                      <div
                        className={`w-10 h-10 rounded-full flex items-center justify-center font-bold transition-all ${
                          currentStep > step
                            ? 'bg-green-500 text-white'
                            : currentStep === step
                            ? 'bg-white text-primary-600 ring-4 ring-white/30'
                            : 'bg-white/30 text-white/60'
                        }`}
                      >
                        {currentStep > step ? <Check className="w-5 h-5" /> : step}
                      </div>
                      <span className="text-xs mt-2 font-medium">
                        {step === 1 && 'Basic Info'}
                        {step === 2 && 'Pricing'}
                        {step === 3 && 'Stock & Medical'}
                        {step === 4 && 'Additional'}
                      </span>
                    </div>
                    {step < 4 && (
                      <div
                        className={`h-1 flex-1 mx-2 rounded transition-all ${
                          currentStep > step ? 'bg-green-500' : 'bg-white/30'
                        }`}
                      />
                    )}
                  </div>
                ))}
              </div>
            </div>

            <form onSubmit={handleSubmit} className="p-6">
              {/* Step 1: Basic Information */}
              {currentStep === 1 && (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-gray-900 mb-6 pb-3 border-b-2 border-primary-200">
                    ðŸ“‹ Basic Information
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Medicine Name *
                  </label>
                  <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleInputChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Generic Name
                  </label>
                  <input
                    type="text"
                    name="generic_name"
                    value={formData.generic_name}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Category
                  </label>
                  <select
                    name="category_id"
                    value={formData.category_id}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  >
                    <option value="">Select Category</option>
                    {categories.map((cat) => (
                      <option key={cat.id} value={cat.id}>
                        {cat.name}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Manufacturer
                  </label>
                  <input
                    type="text"
                    name="manufacturer"
                    value={formData.manufacturer}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                {/* Purchase Information */}
                <div className="md:col-span-2 mt-4">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">
                    Purchase Information
                  </h3>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Purchase Price per Carton
                  </label>
                  <input
                    type="number"
                    name="purchase_price_per_carton"
                    value={formData.purchase_price_per_carton}
                    onChange={handleInputChange}
                    step="0.01"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Units per Carton *
                  </label>
                  <input
                    type="number"
                    name="units_per_carton"
                    value={formData.units_per_carton}
                    onChange={handleInputChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                {/* Selling Prices */}
                <div className="md:col-span-2 mt-4">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">
                    Selling Prices
                  </h3>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Full Dose Price *
                  </label>
                  <input
                    type="number"
                    name="selling_price_full"
                    value={formData.selling_price_full}
                    onChange={handleInputChange}
                    step="0.01"
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Half Dose Price
                  </label>
                  <input
                    type="number"
                    name="selling_price_half"
                    value={formData.selling_price_half}
                    onChange={handleInputChange}
                    step="0.01"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Single Unit Price
                  </label>
                  <input
                    type="number"
                    name="selling_price_single"
                    value={formData.selling_price_single}
                    onChange={handleInputChange}
                    step="0.01"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                {/* Stock Information */}
                <div className="md:col-span-2 mt-4">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">
                    Stock Information
                  </h3>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Quantity in Stock
                  </label>
                  <input
                    type="number"
                    name="quantity_in_stock"
                    value={formData.quantity_in_stock}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Reorder Level
                  </label>
                  <input
                    type="number"
                    name="reorder_level"
                    value={formData.reorder_level}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                {/* Medical Information */}
                <div className="md:col-span-2 mt-4">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">
                    Medical Information
                  </h3>
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Diseases Treated
                  </label>
                  <textarea
                    name="diseases_treated"
                    value={formData.diseases_treated}
                    onChange={handleInputChange}
                    rows={3}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Dosage Form
                  </label>
                  <input
                    type="text"
                    name="dosage_form"
                    value={formData.dosage_form}
                    onChange={handleInputChange}
                    placeholder="e.g., Tablet, Syrup, Injection"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Strength
                  </label>
                  <input
                    type="text"
                    name="strength"
                    value={formData.strength}
                    onChange={handleInputChange}
                    placeholder="e.g., 500mg, 250mg/5ml"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Usage Instructions
                  </label>
                  <textarea
                    name="usage_instructions"
                    value={formData.usage_instructions}
                    onChange={handleInputChange}
                    rows={3}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Side Effects
                  </label>
                  <textarea
                    name="side_effects"
                    value={formData.side_effects}
                    onChange={handleInputChange}
                    rows={3}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                {/* Dates */}
                <div className="md:col-span-2 mt-4">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">
                    Dates & Additional Info
                  </h3>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Manufacture Date
                  </label>
                  <input
                    type="date"
                    name="manufacture_date"
                    value={formData.manufacture_date}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Expiry Date *
                  </label>
                  <input
                    type="date"
                    name="expiry_date"
                    value={formData.expiry_date}
                    onChange={handleInputChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Barcode
                  </label>
                  <input
                    type="text"
                    name="barcode"
                    value={formData.barcode}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Shelf Location
                  </label>
                  <input
                    type="text"
                    name="shelf_location"
                    value={formData.shelf_location}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>
              </div>

              <div className="flex justify-end space-x-4 mt-6 pt-6 border-t border-gray-200">
                <button
                  type="button"
                  onClick={() => setShowAddModal(false)}
                  disabled={submitting}
                  className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={submitting}
                  className="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                  {submitting ? 'Adding...' : 'Add Medicine'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* View Medicine Modal */}
      {showViewModal && selectedMedicine && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
              <h2 className="text-2xl font-bold text-gray-900">Medicine Details</h2>
              <button
                onClick={() => {
                  setShowViewModal(false);
                  setSelectedMedicine(null);
                }}
                className="text-gray-500 hover:text-gray-700 text-3xl"
              >
                Ã—
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* Basic Info */}
              <div>
                <h3 className="text-lg font-semibold text-gray-900 mb-3">Basic Information</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600">Medicine Name</p>
                    <p className="font-medium text-gray-900">{selectedMedicine.name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Generic Name</p>
                    <p className="font-medium text-gray-900">{selectedMedicine.generic_name || 'N/A'}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Category</p>
                    <p className="font-medium text-gray-900">{selectedMedicine.category_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Manufacturer</p>
                    <p className="font-medium text-gray-900">{selectedMedicine.manufacturer || 'N/A'}</p>
                  </div>
                </div>
              </div>

              {/* Pricing */}
              <div>
                <h3 className="text-lg font-semibold text-gray-900 mb-3">Pricing</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600">Carton Price</p>
                    <p className="font-medium text-gray-900">TZS {selectedMedicine.purchase_price_per_carton?.toLocaleString()}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Units Per Carton</p>
                    <p className="font-medium text-gray-900">{selectedMedicine.units_per_carton}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Full Dose Price</p>
                    <p className="font-medium text-gray-900">TZS {selectedMedicine.selling_price_full?.toLocaleString()}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Half Dose Price</p>
                    <p className="font-medium text-gray-900">TZS {selectedMedicine.selling_price_half?.toLocaleString()}</p>
                  </div>
                </div>
              </div>

              {/* Stock Info */}
              <div>
                <h3 className="text-lg font-semibold text-gray-900 mb-3">Stock Information</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600">Current Stock</p>
                    <p className="font-medium text-gray-900">{selectedMedicine.quantity_in_stock} units</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Reorder Level</p>
                    <p className="font-medium text-gray-900">{selectedMedicine.reorder_level} units</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Expiry Date</p>
                    <p className="font-medium text-gray-900">{new Date(selectedMedicine.expiry_date).toLocaleDateString()}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Status</p>
                    <div>{getStatusBadge(selectedMedicine.stock_status)}</div>
                  </div>
                </div>
              </div>

              {/* Medical Info */}
              {selectedMedicine.diseases_treated && (
                <div>
                  <h3 className="text-lg font-semibold text-gray-900 mb-3">Medical Information</h3>
                  <div className="space-y-3">
                    <div>
                      <p className="text-sm text-gray-600">Diseases Treated</p>
                      <p className="font-medium text-gray-900">{selectedMedicine.diseases_treated}</p>
                    </div>
                    {selectedMedicine.dosage_form && (
                      <div>
                        <p className="text-sm text-gray-600">Dosage Form</p>
                        <p className="font-medium text-gray-900">{selectedMedicine.dosage_form}</p>
                      </div>
                    )}
                    {selectedMedicine.strength && (
                      <div>
                        <p className="text-sm text-gray-600">Strength</p>
                        <p className="font-medium text-gray-900">{selectedMedicine.strength}</p>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>

            <div className="border-t border-gray-200 px-6 py-4 flex justify-end">
              <button
                onClick={() => {
                  setShowViewModal(false);
                  setSelectedMedicine(null);
                }}
                className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Edit Medicine Modal */}
      {showEditModal && selectedMedicine && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
              <h2 className="text-2xl font-bold text-gray-900">Edit Medicine</h2>
              <button
                onClick={() => {
                  setShowEditModal(false);
                  setSelectedMedicine(null);
                  resetForm();
                }}
                className="text-gray-500 hover:text-gray-700 text-3xl"
              >
                Ã—
              </button>
            </div>

            <form onSubmit={handleUpdate} className="p-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Same form fields as Add Modal */}
                <div className="md:col-span-2">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">
                    Basic Information
                  </h3>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Medicine Name *
                  </label>
                  <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleInputChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Generic Name
                  </label>
                  <input
                    type="text"
                    name="generic_name"
                    value={formData.generic_name}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Category
                  </label>
                  <select
                    name="category_id"
                    value={formData.category_id}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  >
                    <option value="">Select Category</option>
                    {categories.map((cat) => (
                      <option key={cat.id} value={cat.id}>
                        {cat.name}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Selling Price (Full) *
                  </label>
                  <input
                    type="number"
                    name="selling_price_full"
                    value={formData.selling_price_full}
                    onChange={handleInputChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Stock Quantity *
                  </label>
                  <input
                    type="number"
                    name="quantity_in_stock"
                    value={formData.quantity_in_stock}
                    onChange={handleInputChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Expiry Date *
                  </label>
                  <input
                    type="date"
                    name="expiry_date"
                    value={formData.expiry_date}
                    onChange={handleInputChange}
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                  />
                </div>
              </div>

              <div className="flex justify-end space-x-4 mt-6 pt-6 border-t border-gray-200">
                <button
                  type="button"
                  onClick={() => {
                    setShowEditModal(false);
                    setSelectedMedicine(null);
                    resetForm();
                  }}
                  disabled={submitting}
                  className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={submitting}
                  className="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                  {submitting ? 'Updating...' : 'Update Medicine'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Export Modal */}
      {showExportModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-md w-full p-6">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">Export Medicines</h2>
            <p className="text-gray-600 mb-6">Choose export format:</p>

            <div className="space-y-3">
              <button
                onClick={() => {
                  exportToExcel();
                  setShowExportModal(false);
                }}
                className="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2"
              >
                <FileSpreadsheet className="w-5 h-5" />
                <span>Export to Excel (CSV)</span>
              </button>

              <button
                onClick={() => {
                  exportToPDF();
                  setShowExportModal(false);
                }}
                className="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
              >
                <FileText className="w-5 h-5" />
                <span>Export to PDF</span>
              </button>

              <button
                onClick={() => setShowExportModal(false)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Import Modal */}
      {showImportModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-md w-full p-6">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">Import Medicines</h2>
            <p className="text-gray-600 mb-4">Upload a CSV file with medicine data</p>

            <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <p className="text-sm text-blue-800 font-semibold mb-2">CSV Format Required:</p>
              <p className="text-xs text-blue-700">
                Headers: Name, Generic Name, Category, Manufacturer, Stock, Price (Full), Expiry Date
              </p>
            </div>

            <input
              ref={fileInputRef}
              type="file"
              accept=".csv"
              onChange={handleFileImport}
              className="hidden"
            />

            <div className="space-y-3">
              <button
                onClick={() => fileInputRef.current?.click()}
                className="w-full px-4 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center justify-center space-x-2"
              >
                <Upload className="w-5 h-5" />
                <span>Choose CSV File</span>
              </button>

              <button
                onClick={() => setShowImportModal(false)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
